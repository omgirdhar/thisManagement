<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Users | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <link href="/css/sidebar.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/commonNavbar}"></div>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div th:replace="~{fragments/commonSidebar}"></div>

    <!-- Main Content -->
	<main class="col-lg-10 ms-auto p-4">
	  <h2 class="mb-4">Projects Management</h2>

	  <ul class="nav nav-tabs">
	    <li class="nav-item">
	      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">
	        Create Project
	      </button>
	    </li>
	    <li class="nav-item">
	      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#list">
	        Project List
	      </button>
	    </li>
	  </ul>

	  <div class="tab-content pt-4">

	    <!-- LIST -->
	    <div class="tab-pane fade" id="list">
	      <table class="table table-bordered">
	        <thead class="table-dark">
	          <tr>
	            <th>#</th>
	            <th>Name</th>
	            <th>Alias</th>
	            <th>Status</th>
	            <th>Actions</th>
	          </tr>
	        </thead>
	        <tbody>
	          <tr th:each="project, stat : ${projectList}">
	            <td th:text="${stat.count}"></td>
	            <td th:text="${project.name}"></td>
	            <td th:text="${project.alias}"></td>
	            <td th:text="${project.status}"></td>
	            <td>
	              <button class="btn btn-sm btn-primary"
	                      th:onclick="openEditModal([[${project.id}]])">
	                <i class="bi bi-pencil"></i>
	              </button>
				  <button class="btn btn-sm btn-secondary"
				          th:onclick="openAssignUsersModal([[${project.id}]])">
				    <i class="bi bi-people"></i>
				  </button>
	              <a th:href="@{/deleteProject/{id}(id=${project.id})}"
	                 class="btn btn-sm btn-danger"
					 onclick="return confirm('Are you sure?')">
	                <i class="bi bi-trash"></i>
	              </a>
	            </td>
	          </tr>
	        </tbody>
	      </table>
	    </div>

	    <!-- CREATE -->
	    <div class="tab-pane fade show active" id="create">
	      <form th:action="@{/saveProject}" method="post" th:object="${newProject}">
	        <div class="row g-3">
	          <div class="col-md-6">
	            <input class="form-control" th:field="*{name}" placeholder="Project Name" required>
	          </div>
	          <div class="col-md-6">
	            <input class="form-control" th:field="*{alias}" placeholder="Alias" required>
	          </div>
	          <div class="col-md-6">
	            <select class="form-select" th:field="*{status}" required>
				  <option value="">Select Status</option>
	              <option value="ACTIVE">ACTIVE</option>
	              <option value="INACTIVE">INACTIVE</option>
	            </select>
	          </div>
	        </div>

			<div class="mt-4">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-save"></i> Save Project
              </button>
              <button type="reset" class="btn btn-secondary">
                Reset
              </button>
            </div>
	      </form>
	    </div>

	  </div>
	</main>
  </div>
</div>

<!-- EDIT PROJECT MODAL -->
<div class="modal fade" id="editProjectModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/updateProject}" method="post">
        <div class="modal-header">
          <h5>Edit Project</h5>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editId" name="id">

          <input class="form-control mb-2" id="editName" name="name">
          <input class="form-control mb-2" id="editAlias" name="alias">

          <select class="form-select" id="editStatus" name="status">
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ASSIGN USERS MODAL -->
<div class="modal fade" id="assignUsersModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow">

      <!-- Header -->
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">
          <i class="bi bi-people-fill me-2"></i>
          Assign Users to Project
        </h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <input type="hidden" id="assignProjectId">

        <div class="row g-4">

          <!-- Available Users -->
          <div class="col-md-6">
            <div class="card h-100 border-secondary">
              <div class="card-header bg-light fw-semibold">
                <i class="bi bi-person-plus me-1"></i>
                Available Users
              </div>

              <div class="card-body p-2" style="max-height: 350px; overflow-y: auto;">
                <div id="availableUsers" class="list-group list-group-flush">
                  <!-- populated by JS -->
                </div>
              </div>
            </div>
          </div>

          <!-- Assigned Users -->
          <div class="col-md-6">
            <div class="card h-100 border-success">
              <div class="card-header bg-light fw-semibold text-success">
                <i class="bi bi-check-circle me-1"></i>
                Assigned Users
              </div>

              <div class="card-body p-2" style="max-height: 350px; overflow-y: auto;">
                <div id="assignedUsers" class="list-group list-group-flush">
                  <!-- populated by JS -->
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success"
                onclick="saveUserAssignments()">
          <i class="bi bi-save me-1"></i>
          Save Changes
        </button>
      </div>

    </div>
  </div>
</div>



<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/authFetch.js"></script>
<script>
let projectModal = new bootstrap.Modal(document.getElementById('editProjectModal'));

function openEditModal(id) {
	authFetch(`/updateProject/${id}`)
    .then(p => {
      editId.value = p.id;
      editName.value = p.name;
      editAlias.value = p.alias;
      editStatus.value = p.status;
      projectModal.show();
    });
}
</script>
<script>
	let assignModal = new bootstrap.Modal(
	  document.getElementById('assignUsersModal')
	);

	function openAssignUsersModal(projectId) {
	  document.getElementById('assignProjectId').value = projectId;

	  authFetch(`/projects/${projectId}/users`)
	    .then(users => renderUsers(users));

	  assignModal.show();
	}

	function renderUsers(users) {
	  availableUsers.innerHTML = "";
	  assignedUsers.innerHTML = "";

	  users.forEach(u => {
	    const item = `
	      <label class="list-group-item d-flex align-items-center gap-2">
	        <input class="form-check-input me-2" type="checkbox"
	               value="${u.userId}"
	               ${u.assigned ? "checked" : ""}>
	        <i class="bi bi-person-circle text-muted"></i>
	        <span>${u.name}</span>
	      </label>
	    `;

	    if (u.assigned) {
	      assignedUsers.insertAdjacentHTML("beforeend", item);
	    } else {
	      availableUsers.insertAdjacentHTML("beforeend", item);
	    }
	  });
	}


	function saveUserAssignments() {
	  let projectId = assignProjectId.value;

	  let selectedUsers = [...document.querySelectorAll(
	    '#assignUsersModal input:checked'
	  )].map(cb => cb.value);

	  authFetch(`/projects/${projectId}/users`,{
	    method: "POST",
	    headers: {
	      "Content-Type": "application/json"
	    },
		parseJson: false ,
	    body: JSON.stringify(selectedUsers)
	  }).then(() => assignModal.hide());
	}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="'Task | ' + ${currentTask.title}">Task Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/commonNavbar}"></div>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div th:replace="~{fragments/commonSidebar}"></div>

    <!-- Main Content -->
	<main class="col-lg-10 ms-auto p-4" style="background:#f4f5f7; min-height:100vh;">

	  <div class="row">

	    <!-- ========================= -->
	    <!-- ======= MAIN AREA ======= -->
	    <!-- ========================= -->
	    <div class="col-lg-8">

	      <!-- BREADCRUMB -->
	      <nav aria-label="breadcrumb">
	        <ol class="breadcrumb small">
	          <li class="breadcrumb-item">
	            <a th:href="@{/projects/{id}(id=${project.id})}"
	               th:text="${project.name}">Project</a>
	          </li>

	          <li class="breadcrumb-item"
	              th:if="${currentTask.parentTask != null}">
	            <a th:href="@{/projects/{projectId}/tasks/details/{taskId}(
	                projectId=${project.id},
	                taskId=${currentTask.parentTask.id})}"
	               th:text="${currentTask.parentTask.title}">
	            </a>
	          </li>

	          <li class="breadcrumb-item active"
	              th:text="${currentTask.title}">
	          </li>
	        </ol>
	      </nav>

	      <!-- TITLE -->
	      <h2 class="fw-bold mb-3" th:text="${currentTask.title}"></h2>

	      <!-- META INFO ROW -->
		  <div class="card mb-4">

		    <div class="card-header bg-light fw-semibold">
		      Key Details
		    </div>

		    <div class="card-body">

		      <!-- DESCRIPTION -->
			  <div class="mb-4">
			    <h6 class="text-muted fw-semibold">Description</h6>

			    <!-- VIEW MODE -->
			    <div id="description-view"
			         class="p-3 border rounded bg-white"
			         style="cursor:pointer;"
			         onclick="enableEdit()"
			         th:text="${currentTask.description} ?: 'Click to add description...'">
			    </div>

			    <!-- EDIT MODE -->
			    <div id="description-edit" class="d-none mt-2">
			      <textarea id="description-textarea"
			                class="form-control"
			                rows="4"
			                th:text="${currentTask?.description}">
			      </textarea>

			      <div class="mt-2">
			        <button class="btn btn-primary btn-sm"
			                th:onclick="saveDescription([[${currentTask.id}]])">
			          Save
			        </button>
			        <button class="btn btn-secondary btn-sm"
			                onclick="cancelEdit()">
			          Cancel
			        </button>
			      </div>
			    </div>
			  </div>


		      <!-- META INFO GRID -->
			  <div class="mt-3">

			    <!-- Priority -->
			    <div class="d-flex py-2 border-bottom align-items-center">
			      <div style="width: 200px;" class="text-muted">Priority</div>
			      <div>
			        <span class="badge bg-danger">High</span>
			      </div>
			    </div>

			    <!-- Due Date -->
			    <div class="d-flex py-2 border-bottom align-items-center">
			      <div style="width: 200px;" class="text-muted">Due Date</div>
			      <div th:text="${currentTask.dueDate} ?: '-'"></div>
			    </div>

			    <!-- Start Date -->
			    <div class="d-flex py-2 border-bottom align-items-center">
			      <div style="width: 200px;" class="text-muted">Start Date</div>
			      <div>-</div>
			    </div>

			    <!-- Original Estimate -->
			    <div class="d-flex py-2 align-items-center">
			      <div style="width: 200px;" class="text-muted">Original Estimate</div>
			      <div>--</div>
			    </div>

			  </div>


		    </div>
		  </div>


	      <!-- SUBTASKS -->
	      <div th:if="${childTasks != null && !childTasks.isEmpty()}">
	        <div class="card mb-4">
	          <div class="card-header bg-light fw-semibold">
	            Subtasks
	          </div>
	          <div class="card-body p-0">
	            <table class="table table-hover mb-0">
	              <thead class="table-light">
	                <tr>
	                  <th>ID</th>
	                  <th>Title</th>
	                  <th>Assignee</th>
	                  <th>Status</th>
	                </tr>
	              </thead>
	              <tbody>
	                <tr th:each="task : ${childTasks}">
	                  <td th:text="${task.id}"></td>
	                  <td>
	                    <a th:href="@{/projects/{projectId}/tasks/details/{taskId}(
	                          projectId=${project.id},
	                          taskId=${task.id})}"
	                       th:text="${task.title}">
	                    </a>
	                  </td>
	                  <td th:text="${task.assignee != null 
	                        ? task.assignee.firstName + ' ' + task.assignee.lastName 
	                        : 'Unassigned'}">
	                  </td>
	                  <td>
	                    <span class="badge bg-secondary"
	                          th:text="${task.status}">
	                    </span>
	                  </td>
	                </tr>
	              </tbody>
	            </table>
	          </div>
	        </div>
	      </div>

	      <!-- COMMENTS SECTION -->
	      <div class="card">
	        <div class="card-header bg-light fw-semibold">
	          Comments
	        </div>
	        <div class="card-body">
	          <p class="text-muted">No comments yet.</p>

	          <textarea class="form-control mb-2"
	                    rows="3"
	                    placeholder="Add a comment..."></textarea>
	          <button class="btn btn-primary btn-sm">
	            Add Comment
	          </button>
	        </div>
	      </div>

	    </div>


	    <!-- ========================= -->
	    <!-- ===== RIGHT DRAWER ====== -->
	    <!-- ========================= -->
	    <div class="col-lg-4">

	      <div class="card mb-3">
	        <div class="card-body">

	          <!-- STATUS DROPDOWN (static for now) -->
	          <div class="mb-4">
	            <label class="fw-semibold mb-2">Status</label>
	            <div class="dropdown">
	              <button class="btn btn-success dropdown-toggle w-100"
	                      type="button"
	                      data-bs-toggle="dropdown">
	                <span th:text="${currentTask.status}">In Progress</span>
	              </button>
	              <ul class="dropdown-menu w-100">
	                <li><a class="dropdown-item" href="#">To Do</a></li>
	                <li><a class="dropdown-item" href="#">In Progress</a></li>
	                <li><a class="dropdown-item" href="#">Done</a></li>
	              </ul>
	            </div>
	          </div>

	          <!-- DETAILS DROPDOWN -->
	          <div class="accordion" id="detailsAccordion">
	            <div class="accordion-item">
	              <h2 class="accordion-header">
	                <button class="accordion-button"
	                        type="button"
	                        data-bs-toggle="collapse"
	                        data-bs-target="#detailsCollapse">
	                  Details
	                </button>
	              </h2>
	              <div id="detailsCollapse"
	                   class="accordion-collapse collapse show"
	                   data-bs-parent="#detailsAccordion">
	                <div class="accordion-body small">

	                  <p>
	                    <strong>Assignee:</strong><br>
	                    <span th:text="${currentTask.assignee != null 
	                      ? currentTask.assignee.firstName + ' ' + currentTask.assignee.lastName 
	                      : 'Unassigned'}">
	                    </span>
	                  </p>

	                  <p>
	                    <strong>Reporter:</strong><br>
	                    <span>System</span>
	                  </p>

	                  <p>
	                    <strong>Time Tracking:</strong><br>
	                    No time logged
	                  </p>

	                  <p>
	                    <strong>Labels:</strong><br>
	                    <span class="badge bg-secondary">backend</span>
	                    <span class="badge bg-secondary">api</span>
	                  </p>

	                </div>
	              </div>
	            </div>
	          </div>

	        </div>
	      </div>

	    </div>

	  </div>

	</main>

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/sidebar.js"></script>
<script th:inline="javascript">
  function enableEdit() {
    document.getElementById("description-view").classList.add("d-none");
    document.getElementById("description-edit").classList.remove("d-none");
  }

  function cancelEdit() {
    document.getElementById("description-edit").classList.add("d-none");
    document.getElementById("description-view").classList.remove("d-none");
  }

  function saveDescription(taskId) {

    const newDescription =
        document.getElementById("description-textarea").value;
		var projectId = /*[[${project.id}]]*/0;
    fetch(`/projects/${projectId}/tasks/${taskId}/description`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        description: newDescription
      })
    })
    .then(response => {
      if (response.ok) {
        document.getElementById("description-view").innerText =
            newDescription || "Click to add description...";

        cancelEdit();
      } else {
        alert("Failed to update description");
      }
    });
  }
</script>

</body>
</html>

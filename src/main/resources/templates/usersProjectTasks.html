<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="'Tasks | ' + ${project.name}">Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/commonNavbar}"></div>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div th:replace="~{fragments/commonSidebar}"></div>

    <!-- Main Content -->
    <main class="col-lg-10 ms-auto p-4" style="background: #f0f2f5; min-height: 100vh;">
      <h2 class="mb-4 text-primary fw-bold" th:text="${project.name} + ' - Tasks'">Project Tasks</h2>

      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">
            Create Task
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#list">
            Task List
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CREATE TASK FORM -->
        <div class="tab-pane fade show active" id="create">
          <form th:action="@{/projects/{projectId}/tasks/save(projectId=${project.id})}" method="post" th:object="${newTask}">
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <input class="form-control" th:field="*{title}" placeholder="Task Title" required>
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control" th:field="*{dueDate}" required>
              </div>
              <div class="col-md-3">
                <select class="form-select" th:field="*{assignee.id}" required>
                  <option value="">Select Assignee</option>
                  <option th:each="user : ${projectUsers}"
                          th:value="${user.id}"
                          th:text="${user.firstName + ' ' + user.lastName}">
                  </option>
                </select>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-3">
                <select class="form-select" th:field="*{status}" required>
                  <option value="PENDING">PENDING</option>
                  <option value="IN_PROGRESS">IN_PROGRESS</option>
                  <option value="COMPLETED">COMPLETED</option>
                </select>
              </div>
            </div>

            <div class="mt-3">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-save"></i> Save Task
              </button>
              <button type="reset" class="btn btn-secondary">Reset</button>
            </div>
          </form>
        </div>

        <!-- TASK LIST -->
        <div class="tab-pane fade" id="list">
          <table class="table table-bordered table-hover">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Assignee</th>
                <th>Due Date</th>
                <!--<th>Status</th>-->
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="task, stat : ${taskList}">
                <td th:text="${stat.count}"></td>
                <td th:text="${task.title}"></td>
                <td th:text="${task.assignee != null ? task.assignee.firstName + ' ' + task.assignee.lastName : 'Unassigned'}"></td>
                <td th:text="${task.dueDate}"></td>
                <!--<td th:text="${task.status}" 
                    th:classappend="${task.status == 'COMPLETED'} ? ' text-success' : 
                                    (task.status == 'IN_PROGRESS') ? ' text-primary' : ' text-warning'">
                </td>-->
                <td>
                  <button class="btn btn-sm btn-primary"
                          th:onclick="openEditModal([[${task.id}]])">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a th:href="@{/projects/{projectId}/tasks/delete/{taskId}(projectId=${project.id},taskId=${task.id})}"
                     class="btn btn-sm btn-danger"
                     onclick="return confirm('Are you sure?')">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- EDIT TASK MODAL -->
<div class="modal fade" id="editTaskModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/projects/{projectId}/tasks/update(projectId=${project.id})}" method="post">
        <div class="modal-header">
          <h5>Edit Task</h5>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editId" name="id">

          <input class="form-control mb-2" id="editTitle" name="title" placeholder="Task Title">
          <input type="date" class="form-control mb-2" id="editDueDate" name="dueDate">

          <select class="form-select mb-2" id="editAssignee" name="assignee.id" required>
            <option value="">Select Assignee</option>
            <option th:each="user : ${projectUsers}" 
                    th:value="${user.id}" 
                    th:text="${user.firstName + ' ' + user.lastName}">
            </option>
          </select>

          <select class="form-select" id="editStatus" name="status" required>
            <option value="PENDING">PENDING</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="COMPLETED">COMPLETED</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Update Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/authFetch.js"></script>

<script>
let editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));

function openEditModal(taskId) {
  authFetch(`/projects/${taskId}/tasks/taskDetails?taskId=${taskId}`)
    .then(task => {
      document.getElementById('editId').value = task.id;
      document.getElementById('editTitle').value = task.title;
      document.getElementById('editDueDate').value = task.dueDate;
      document.getElementById('editAssignee').value = task.assignee ? task.assignee.id : '';
      document.getElementById('editStatus').value = task.status;
      editModal.show();
    });
}
</script>

</body>
</html>

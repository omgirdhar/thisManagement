<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="'Tasks | ' + ${project.name}">Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/commonNavbar}"></div>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div th:replace="~{fragments/commonSidebar}"></div>

    <!-- Main Content -->
    <main class="col-lg-10 ms-auto p-4" style="background: #f0f2f5; min-height: 100vh;">
		<div class="d-flex justify-content-between align-items-center mb-3">
		  <h2 class="text-primary fw-bold"
		      th:text="${project.name} + ' - Tasks'">Project Tasks</h2>

		  <button class="btn btn-primary"
		          data-bs-toggle="modal"
		          data-bs-target="#createTaskModal">
		    + Create
		  </button>
		</div>

        <!-- TASK LIST -->
		<table class="table table-bordered table-hover">
		  <thead class="table-dark">
		    <tr>
		      <th>#</th>
		      <th>Title</th>
		      <th>Assignee</th>
		      <th>Due Date</th>
		      <th>Status</th>
		      <th>Type</th>
		      <th>Actions</th>
		    </tr>
		  </thead>
		  <tbody>
		    <tr th:each="task : ${taskList}">
		      <td th:text="${task.id}"></td>
		      <td th:style="${task.parentTask != null} ? 'padding-left: 2rem;' : ''">
		        <a th:href="@{/projects/{projectId}/tasks/details/{taskId}(projectId=${project.id},taskId=${task.id})}"
		           th:text="${task.title}"></a>
		      </td>
		      <td th:text="${task.assignee != null ? task.assignee.firstName + ' ' + task.assignee.lastName : 'Unassigned'}"></td>
		      <td th:text="${task.dueDate}"></td>
		      <td th:text="${task.status}"
		          th:class="${(task.status == 'COMPLETED') ? 'text-success' : (task.status == 'IN_PROGRESS') ? 'text-primary' : 'text-warning'}">
		      </td>
		      <td th:text="${task.taskType}"></td>
		      <td>
		        <button class="btn btn-sm btn-primary"
		                th:onclick="openEditModal([[${task.id}]])">
		          <i class="bi bi-pencil"></i>
		        </button>
		      </td>
		    </tr>
		  </tbody>
		</table>


    </main>
  </div>
</div>

<!--CREATE TASK MODAL-->
<div class="modal fade" id="createTaskModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <form th:action="@{/projects/{projectId}/tasks/save(projectId=${project.id})}"
            method="post"
            th:object="${newTask}">

        <div class="modal-header">
          <h5 class="modal-title">Create Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

			<select class="form-select mb-2"
			        th:field="*{taskType}"
			        required>
			  <option th:value="EPIC">Epic</option>
			  <option th:value="STORY">Story</option>
			  <option th:value="TASK">Task</option>
			  <option th:value="SUB_TASK">Sub-task</option>
			</select>
			
			<select class="form-select mb-2"
			        name="parentTaskId"
			        id="parentTaskSelect">
			  <option value="">No Parent</option>
			  <option th:each="task : ${allTasks}"
			          th:value="${task.id}"
			          th:text="${task.title}">
			  </option>
			</select>
			
          <input class="form-control mb-2"
                 th:field="*{title}"
                 placeholder="Task title"
                 required>

          <input type="date"
                 class="form-control mb-2"
                 th:field="*{dueDate}"
                 required>

          <select class="form-select mb-2"
                  th:field="*{assignee.id}"
                  required>
            <option value="">Select Assignee</option>
            <option th:each="user : ${projectUsers}"
                    th:value="${user.id}"
                    th:text="${user.firstName + ' ' + user.lastName}">
            </option>
          </select>

          <select class="form-select"
                  th:field="*{status}"
                  required>
            <option value="PENDING">PENDING</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="COMPLETED">COMPLETED</option>
          </select>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary"
                  data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success">Create</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- EDIT TASK MODAL -->
<div class="modal fade" id="editTaskModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form th:action="@{/projects/{projectId}/tasks/update(projectId=${project.id})}" method="post">
        <div class="modal-header">
          <h5>Edit Task</h5>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editId" name="id">

          <input class="form-control mb-2" id="editTitle" name="title" placeholder="Task Title">
          <input type="date" class="form-control mb-2" id="editDueDate" name="dueDate">

          <select class="form-select mb-2" id="editAssignee" name="assignee.id" required>
            <option value="">Select Assignee</option>
            <option th:each="user : ${projectUsers}" 
                    th:value="${user.id}" 
                    th:text="${user.firstName + ' ' + user.lastName}">
            </option>
          </select>

          <select class="form-select" id="editStatus" name="status" required>
            <option value="PENDING">PENDING</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="COMPLETED">COMPLETED</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Update Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/authFetch.js"></script>

<script>
let editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));

function openEditModal(taskId) {
  authFetch(`/projects/${taskId}/tasks/taskDetails?taskId=${taskId}`)
    .then(task => {
      document.getElementById('editId').value = task.id;
      document.getElementById('editTitle').value = task.title;
      document.getElementById('editDueDate').value = task.dueDate;
      document.getElementById('editAssignee').value = task.assignee ? task.assignee.id : '';
      document.getElementById('editStatus').value = task.status;
      editModal.show();
    });
}
</script>
<script>
const taskTypeSelect = document.querySelector('[name="taskType"]');
const parentSelect = document.getElementById('parentTaskSelect');

taskTypeSelect.addEventListener('change', () => {
  if (taskTypeSelect.value === 'SUB_TASK') {
    parentSelect.required = true;
  } else {
    parentSelect.required = false;
    parentSelect.value = '';
  }
});
</script>


</body>
</html>
